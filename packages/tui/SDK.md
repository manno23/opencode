# TUI SDK Plan and Structure

This document describes how the TUI will consume a newly generated Go SDK (using ogen), where the code will live, the generation workflow, and key decisions/features to leverage. It mirrors the structure and intent of packages/opencode/README.md, but tailored for the TUI and enriched with planning notes, ogen capabilities, and migration insights.

## Repository layout

Target structure after restructuring:

```text
packages/tui/
├── api/                  # OpenAPI spec and generated client
│   ├── generate.go
│   ├── openapi.json      # OpenAPI v3 spec (generated by the opencode bun server)
│   ├── openapi.yml       # OpenAPI v3 spec (our manually specified additions to the spec)
│   ├── ogen.yml          # Ogen configuration
│   └── ogen/             # Generated Go client code (DO NOT EDIT)
├── internal/             # existing TUI internals (components, layout, styles, theme, etc.)
│   ├── api/
│   ├── app/
│   │   ├── app.go
│   │   └── client/
│   │       └── client.go
│   ├── attachment/
│   ├── components/
│   ├── commands/
│   │   └── get.go
│   ├── layout/
│   ├── styles/
│   ├── theme/
│   ├── tui/              # Bubble Tea models/views
│   │   └── tui.go
│   └── ...
└── cmd/
    └── opencode/
        └── main.go
```

Notes:

- api/ogen is fully generated by ogen and should be excluded from linting that enforces local style rules when possible.
- Keep UI and app state in internal/ and cmd/tui/, not in the SDK.
- The app/app.go will orchestrate calls to api/ogen via app/client/client.go helpers for auth/retry.

## Build and run

- Go TUI build (similar to packages/opencode/README.md release path), example local build:

````
Optional: Convert to editable YAML for extensions (e.g., x-ogen-* for unions/validators; use jq for JSON->YAML):

```bash
jq -S . packages/tui/api/openapi.json > packages/tui/api/openapi.yaml  # Pretty-print to YAML # Edit openapi.yaml (e.g., add discriminators for Event oneOf, groups for Session/TUI paths) +```
+  Note: Ogen accepts both JSON/YAML directly (--spec ./openapi.json or ./openapi.yaml). Use YAML for customizations; JSON for fidelity to server.


```bash
cd packages/tui
CGO_ENABLED=0 go build -ldflags="-s -w -X main.Version=$(git describe --tags --always)" -o tui cmd/main.go
````

- During release, the opencode bundling step can still embed the TUI binary as before (see packages/opencode/README.md for reference build commands).

## Testing

The TUI SDK uses a comprehensive mock-based testing strategy for the ogen client and facade implementations to ensure high coverage and reliability.

### Mock Strategy

- **httptest.Server**: Use Go's httptest package to create mock HTTP servers with custom handlers that return schema-conformant JSON responses for valid requests and appropriate error responses for invalid cases.
- **Dynamic Operation Enumeration**: Load the OpenAPI spec using kin-openapi and enumerate all paths and operations to test them dynamically.
- **Test Variants**: For each operation, test multiple variants including valid inputs, invalid required fields, invalid enums, and edge cases.
- **Facade Testing**: Use the same mock server infrastructure to test both Legacy and Ogen implementations of the facade clients, ensuring parity and correct switching.

### Running Tests

- Client tests: `go test ./api/ogen -v -cover`
- Facade tests: `go test ./internal/app/client -v -cover`
- Coverage goal: >80% for client, decode, and validate functions.

### Coverage Goals

Achieve comprehensive coverage on:

- All client operations and their unmarshaling.
- Validation errors for invalid inputs.
- Facade switching between Legacy and Ogen implementations.
- Schema compliance and edge cases.

## SDK generation with ogen

- Use go:generate for reproducible SDK builds.
- Add a generate file:

```go
// filepath: packages/tui/api/generate.go
//go:build generate
// +build generate

package api

//go:generate sh -c "ogen --clean --config ./ogen.yml --target ./ogen --package api ./openapi.yaml"
```

- Provide an ogen.yml alongside openapi.yaml to configure generation (see Examples below).
- Commit openapi.yaml and ogen.yml. Commit generated code (ogen/) only if desired; otherwise, generate in CI and vendor artifacts.

## ogen configuration references

- Full config reference: https://github.com/ogen-go/ogen/blob/main/examples/_config/example_all.yml
- Features: https://ogen.dev/docs/features
- Extensions/customisation: https://ogen.dev/docs/extensions
- Sum Types: https://ogen.dev/docs/types/sumtype
- Optional Types: https://ogen.dev/docs/types/optional
- Streaming/SSE PR context: https://github.com/ogen-go/ogen/pull/1522 (inform implementation of event streams)

Key choices for this project:

- Authentication: Bearer auth via static token provider in app/client/client.go, wired into ogen client using WithRequestEditorFn or auth config in ogen.yml.
- Optional fields: Prefer ogen optional wrappers (e.g., optional.String) over custom helpers like opencode.F.
- Sum types: Enable discriminator-based unions where available in the schema; use discriminator inference when explicit tagging isn’t present.
- Streaming: Use the EventSubscribe endpoint returning an io.Reader-like stream. Ensure context cancellation cleanly tears down the stream; expose a Close helper in the wrapper if needed.
- Errors: Generate typed errors; wrap in a small adapter for consistent user-facing toasts.

Example ogen.yml (illustrative):

```yaml
# filepath: packages/tui/api/ogen.yml
compatibility:
  # prefer pointers for objects to reduce copies
  ptr-for-objects: true
features:
  std-errors: true
  client: true
  server: false
  models: true
http:
  client:
    # Inject Authorization: Bearer <token>
    request-editor: true
package: api
output:
  layout: flat
  # target directory is set by the generate command
```

## SSE and event handling

- The TUI consumes server-sent events (SSE) to update UI state. The generated client should:
  - Expose EventSubscribe(ctx) (or equivalent) that returns a streaming reader plus metadata.
  - Respect ctx cancellation for shutdown.
  - Optionally provide helpers to parse event lines into typed events to reduce custom parsing.
- Reference: PR 1522 discusses native SSE support paths; if native support is insufficient, keep a thin hand-written adapter in app/client that wraps the underlying http.Client and decodes events into generated types.

## What stays in the TUI vs. moves to SDK

Keep (UI/UX-specific):

- Bubble Tea components, layout, styles, theme, keybinds, debounce logic, leader sequences.
- State orchestration like switching between parent/child sessions before sending a prompt.

Move to SDK (or thin wrapper near SDK):

- All API request/response shapes, including optional fields, unions, enums.
- Permissions.Respond call, ToolIds/ToolList unions, and other service endpoints.
- Any manual JSON decoding for /tui/\* API paths in the app; replace with typed SDK calls.
- Event stream wire protocol and retry/backoff (if not native in ogen, put into app/client client.go wrapper once, not in UI code).

Result: TUI code only orchestrates and renders; SDK owns HTTP details.

## Migration checklist (from current opencode-sdk usage)

- Replace opencode.F optionals with ogen optional types.
- Update endpoints to ogen signatures (context-first, Opt\* request wrappers where generated).
- Adjust enum names/nesting where they differ (centralize mapping in app/client if needed).
- Ensure union handling uses generated IsX/AsX helpers (or type switches on generated sum types).
- Verify pointer vs value returns; update nil checks.
- Wire bearer auth and per-request logging/metrics in app/client.
- Validate EventSubscribe streaming works with cancellation and reconnection.

## Useful files while migrating

- TUI event/UI orchestration: packages/tui/internal/tui/tui.go
- App orchestrator and API usage: packages/opencode/internal/app/app.go
- Chat/message flows: packages/opencode/internal/components/chat/messages.go
- Current SDK analysis: packages/sdk/next-go/SDK.md

High-ROI refactors:

- Centralize all API invocations in app/app.go via a typed interface backed by the ogen client.
- Remove JSON body structs in tui.go for /tui/\*; call SDK methods directly.
- Introduce a small typed error adapter to map generated errors to user-friendly toasts.

## Development flow

- Generate the current spec:

```bash
bun run dev generate > packages/tui/api/openapi.json
  OR IF THERE IS PROBLEMS WITH THE BUILD OF `bun run dev`
opencode generate > packages/tui/api/openapi.json
```

- Regenerate client:

```bash
cd packages/tui/api
go generate ./...
```

- Build and run TUI as usual to validate integration.
- CI: run go generate, build, lint, and tests; optionally commit generated code to keep release artifacts deterministic.

## Notes on schema design for better SDK ergonomics

- Prefer explicit discriminators for unions to get clean sum types.
- Use consistent naming for params/paths to reduce adapter code.
- Mark truly optional fields; avoid nullable where possible; prefer optional.\* wrappers.
- Define error responses as structured schemas so ogen can emit typed errors.

## Facade Pattern for SDK Migration

To enable gradual migration from legacy SDK to ogen-generated SDK, we implement a facade pattern in `packages/tui/internal/app/client/`.

### Structure

- `client.go`: Unified Client struct with Sessions and Messages fields, selected via feature flags.
- `sessions.go`: SessionsClient interface with methods like Create, List, Activate, Close.
- `messages.go`: MessagesClient interface with Send and Stream methods.
- `legacy_sessions.go`: LegacyImpl wrapping the existing Go SDK.
- `legacy_messages.go`: LegacyImpl for messages.
- `ogen_sessions.go`: Future OgenImpl (placeholder).

### Usage

```go
client := NewClient(legacySDKClient)
session, err := client.Sessions.Create(ctx, CreateSessionOpts{Name: "test"})
messages := client.Messages.Stream(ctx, sessionID, "hello", nil)
```

### Migration Complete

All domains now use OgenImpl by default, with legacy fallback on failure. Feature flags removed; use `TUI_SDK_USE_LEGACY=true` for full rollback if needed.

This allows transparent switching without changing TUI code in `internal/app/app.go`.

### OgenImpl for Sessions

Implemented in `ogen_sessions.go`, it wraps the generated `api.Client` and provides:

- **Type Mappings**: Maps `CreateSessionOpts` to `OptSessionCreateReq`, `[]Session` to `[]*Session`, etc.
- **Auth**: Uses `OPENCODE_TOKEN` env var, added via custom `authTransport` RoundTripper for Bearer auth.
- **Retries**: Basic exponential backoff for transient errors (max 3 retries, 100ms base delay).
- **Methods**:
  - `Create`: Calls `SessionCreate`, maps response.
  - `List`: Calls `SessionList`, maps to slice of pointers.
  - `Activate`: Placeholder (returns error "not implemented").
  - `Close`: Calls `SessionAbort` for closing sessions.

Enable with `TUI_SDK_EXPERIMENT_SESSIONS=true`. Falls back to legacy if token missing or client creation fails.

### OgenImpl for Messages

Implemented in `messages_ogen.go`, it wraps the generated `api.Client` and provides non-streaming and streaming parity:

- **Non-Streaming Send**: Maps to `PostSessionIdMessage` (SessionMessageCreate), handling `OptMessageReq` for optional fields like parentID, tools. Returns `*Message` mapped from `MessageResponse`.
- **Streaming Stream**: Uses SSE via HTTP client to `POST /sessions/{id}/messages` with `Accept: text/event-stream`. Parses `data:` lines into `*StreamEvent`, handling sum types with `IsX/AsX`. Supports context cancellation and reconnection.
- **Auth and Retries**: Same as Sessions, with Bearer token and retry logic.
- **Error Handling**: Typed errors like `MessageAbortedError`; maps to facade types.
- **Feature Flag**: `TUI_SDK_EXPERIMENT_MESSAGES=true` enables in `client.go`.

Streaming parity ensures event parsing matches legacy, with centralized reconnection in facade. If native SSE insufficient, fallback to manual parsing.

### OgenImpl for Tools

Implemented in `tools_ogen.go`, it wraps the generated `api.Client` and provides tool listing, invocation, and permission management:

- **Type Mappings**: Maps facade `Tool`, `ToolResult`, `Permission` to/from ogen types like `ToolListItem`, `ToolInvokeRes`, `Permission`.
- **Auth and Retries**: Same as Sessions and Messages, with Bearer token and exponential backoff.
- **Methods**:
  - `List`: Calls `ToolList`, maps to `[]*Tool`.
  - `Invoke`: Calls `ToolInvoke` with JSON-marshaled params, maps response to `*ToolResult`.
  - `GetPermissions`: Calls `SessionPermissions`, maps to `[]*Permission`.
  - `RespondToPermission`: Calls `SessionPermissionRespond` with response enum.
- **Feature Flag**: `TUI_SDK_EXPERIMENT_TOOLS=true` enables in `client.go`.

Falls back to legacy if token missing or generation issues.

### OgenImpl for Files

Implemented in `files_ogen.go`, it wraps the generated `api.Client` and provides file upload, download, listing, deletion, and retrieval:

- **Type Mappings**: Maps facade `File`, `FileMetadata` to/from ogen types like `File`, handling optional fields with `Opt*` types.
- **Auth and Retries**: Same as other domains, with Bearer token and exponential backoff.
- **Methods**:
  - `Upload`: Calls `FileUpload` with multipart form data, maps response to `*File`.
  - `Download`: Calls `FileDownload`, returns `io.ReadCloser`.
  - `List`: Calls `FileList` with optional limit/offset, maps to `[]*File`.
  - `Delete`: Calls `FileDelete`, returns error.
  - `Get`: Calls `FileGet`, maps to `*File`.
- **Feature Flag**: `TUI_SDK_EXPERIMENT_FILES=true` enables in `client.go`.

Falls back to legacy if token missing or generation issues.

### OgenImpl for Share

Implemented in `share_ogen.go`, it wraps the generated `api.Client` and provides share link creation, fetching shared sessions, and revocation:

- **Type Mappings**: Maps facade `ShareLink`, `Session` to/from ogen types like `ShareLink`, `Session`.
- **Auth and Retries**: Same as other domains, with Bearer token and exponential backoff.
- **Methods**:
  - `Create`: Calls `SessionShareCreate`, maps response to `*ShareLink`.
  - `Fetch`: Calls `ShareGet`, maps response to `*Session`.
  - `Revoke`: Calls `SessionShareDelete`, returns error.
- **Feature Flag**: `TUI_SDK_EXPERIMENT_SHARE=true` enables in `client.go`.

Falls back to legacy if token missing or generation issues.

## Future work

- Add retries with backoff and jitter in app/client for flaky network/SSE.
- Add metrics/log hooks to the ogen client via RequestEditor and response middleware.
- Evaluate generating both server and client from the same spec in a spec-first flow.


MOdules
- packages/tui/api : API 
- packages/sdk/go : SDK
- packages/sdk/go/option : SDK.option
- packages/tui : OPENCODE

├── sdk
│   └── go
│       ├── option         # I need to be able to import this into my module at API
│       ├── packages
│       ├── examples
│       ├── internal
│       ├── lib
│       ├── shared
│       ├── agent.go
│       ├── aliases.go
│       ├── app.go
│       ├── client.go
│       ├── command.go
│       ├── config.go
│       ├── event.go
│       ├── field.go
│       ├── file.go
│       ├── find.go
│       ├── path.go
│       ├── project.go
│       ├── session.go
│       ├── sessionpermission.go
│       ├── tui.go
│       ├── go.mod
│       └── scripts
│
└── tui                    # < github.com/sst/opencode >
    ├── api                     # < github.com/sst/opencode-sdk-go > as API
    │   ├── client
    │   │   ├── client.go           package 'pkgapi'  wraps the  imports [SDK SDK/option SDK/internal/*] and [API/ogen],  presents it as  import (github.com/sst/opencode-sdk-go as opencode)
    │   │   ├── adapter
    │   │   │   ├── legacy.go       pkgapi.Legacy<function></function>(..)
    │   │   │   └── ogen.go         pkgapi.Ogen<function>(..)
    │   │   ├── option
    │   │   │   └── request.go      
    │   │   ├── sessions.go
    │   │   └── types.go
    │   │
    │   ├── generate.go
    │   ├── go.mod
    │   ├── go.sum
    │   ├── ogen
    │   │   ├── <generated go code, package 'ogenapi'
    │   ├── ogen.yml
    │   ├── openapi.yaml
    │   ├── spec
    ├── cmd
    │   └── opencode
    │       └── main.go             package 'main'
    │
    ├── go.mod
    ├── go.sum
    ├── input
    │   ├── go.mod
    └── internal
        ├── api
        │   └── api.go
        ├── app
        │   ├── app.go
        │   ├── prompt.go
        │   ├──
        │   └──
        ├── ...
        └── tui
